<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø°ÙƒØ±Ù†ÙŠ - Ø§Ù„Ù…Ù‡Ø§Ù…</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Tajawal", sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: #fff7f0;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      background-color: #ff8800;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    main {
      width: 100%;
      max-width: 500px;
      margin-top: 20px;
      padding: 10px;
    }

    .section-title {
      font-weight: bold;
      margin: 10px 0;
      color: #ff8800;
      font-size: 1.2rem;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s;
    }

    li:hover {
      transform: scale(1.02);
    }

    .done {
      /* text-decoration removed */
      color: gray;
      opacity: 0.7;
    }

    button {
      background-color: #ff8800;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 1rem;
    }

    button:hover {
      background-color: #ff9900;
    }

    nav {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      header {
        font-size: 1.2rem;
      }
      li {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>ğŸ“‹ Ù…Ù‡Ø§Ù…ÙŠ</header>

  <main>
    <nav>
      <button id="showTasks">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      <button id="showDone">ğŸ“˜ Ø§Ù„Ø³Ø¬Ù„</button>
      <button id="refresh">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </nav>

    <section id="tasks-section">
      <h2 class="section-title">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <ul id="taskList"></ul>
    </section>

    <section id="done-section" class="hidden">
      <h2 class="section-title">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h2>
      <ul id="doneList"></ul>
    </section>
  </main>

  <script>
    const API_URL = "https://zkr-495g.onrender.com/tasks";
    const CODE = "ran/ran*78";

    // ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø© Ø¹Ù†Ø¯ Ø¹Ø±Ø¶Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø£Ø³Ø§Ø³Ù‹Ø§
    function ensureUniqueId(task) {
      if (!task.id) {
        task.id = "task-" + Math.random().toString(36).substr(2, 9);
      }
      return task.id;
    }

    // ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
    async function checkCode() {
      let entered = sessionStorage.getItem("authCode");
      if (entered !== CODE) {
        entered = prompt("ğŸŸ  Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:");
        if (entered === CODE) {
          sessionStorage.setItem("authCode", CODE);
        } else {
          alert("âŒ ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!");
          location.reload();
        }
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
    async function loadTasks(showNotify = false) {
      try {
        const res = await fetch(API_URL);
        const tasks = await res.json();

        tasks.forEach(t => ensureUniqueId(t));

        displayTasks(tasks);
        checkForNewTasks(tasks, showNotify);
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…:", err);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù…
    function displayTasks(tasks) {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      const doneTasks = JSON.parse(localStorage.getItem("doneTasks") || "[]");

      tasks.forEach(task => {
        const id = ensureUniqueId(task);

        if (!doneTasks.includes(id)) {
          const li = document.createElement("li");

          const content = document.createElement("div");
          content.innerHTML = `
            <strong>${task.subject || "Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø©"}</strong><br>
            ${task.text || ""}<br>
            <span style="color:#555;font-size:0.85rem">ID: ${id}</span>
          `;

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.dataset.id = id;

          checkbox.addEventListener("change", () => {
            markDone(id);
          });

          li.appendChild(content);
          li.appendChild(checkbox);
          taskList.appendChild(li);
        }
      });

      displayDoneTasks();
    }

    // ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‡Ù…Ø© Ù…Ù†Ø¬Ø²Ø©
    function markDone(id) {
      const doneTasks = JSON.parse(localStorage.getItem("doneTasks") || "[]");
      if (!doneTasks.includes(id)) {
        doneTasks.push(id);
        localStorage.setItem("doneTasks", JSON.stringify(doneTasks));
        loadTasks();
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
    function displayDoneTasks() {
      const doneList = document.getElementById("doneList");
      const doneTasks = JSON.parse(localStorage.getItem("doneTasks") || "[]");
      doneList.innerHTML = "";

      fetch(API_URL)
        .then(res => res.json())
        .then(tasks => {
          tasks.forEach(t => ensureUniqueId(t));

          tasks
            .filter(t => doneTasks.includes(t.id))
            .forEach(task => {
              const li = document.createElement("li");
              li.classList.add("done");
              li.innerHTML = `
                ${task.subject || "Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø©"} - ${task.text}<br>
                <span style="color:#777;font-size:0.8rem">ID: ${task.id}</span>
              `;
              doneList.appendChild(li);
            });
        });
    }

    // Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function askNotificationPermission() {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    let lastTaskCount = 0;
    function checkForNewTasks(tasks, showNotify) {
      if (showNotify && Notification.permission === "granted") {
        if (tasks.length > lastTaskCount) {
          const newTask = tasks[tasks.length - 1];
          new Notification("ğŸ“š Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", {
            body: `ğŸ“˜ Ù…Ø§Ø¯Ø©: ${newTask.subject}\nâœï¸ ${newTask.text}`,
            icon: "https://cdn-icons-png.flaticon.com/512/4712/4712107.png"
          });
        }
      }
      lastTaskCount = tasks.length;
    }

    // Ø§Ù„ØªÙ†Ù‚Ù„
    document.getElementById("showTasks").onclick = () => {
      document.getElementById("tasks-section").classList.remove("hidden");
      document.getElementById("done-section").classList.add("hidden");
    };
    document.getElementById("showDone").onclick = () => {
      document.getElementById("done-section").classList.remove("hidden");
      document.getElementById("tasks-section").classList.add("hidden");
    };
    document.getElementById("refresh").onclick = () => loadTasks(true);

    // ØªØ´ØºÙŠÙ„
    checkCode();
    askNotificationPermission();
    loadTasks();
    setInterval(() => loadTasks(true), 15000);
  </script>
</body>
</html>
