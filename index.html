<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø°ÙƒØ±Ù†ÙŠ - Ø§Ù„Ù…Ù‡Ø§Ù…</title>

  <style>
    * { box-sizing: border-box; font-family: "Tajawal", sans-serif; margin: 0; padding: 0; }
    body { background: #fff7f0; color: #333; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    header { width: 100%; background-color: #ff8800; color: white; padding: 15px; text-align: center; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    main { width: 100%; max-width: 500px; margin-top: 20px; padding: 10px; }
    .section-title { font-weight: bold; margin: 10px 0; color: #ff8800; font-size: 1.2rem; }
    ul { list-style: none; padding: 0; }
    li { background: white; border-radius: 12px; padding: 12px; margin: 8px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
    li:hover { transform: scale(1.02); }
    .done { text-decoration: line-through; color: gray; opacity: 0.7; }
    button { background-color: #ff8800; color: white; border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; margin-top: 10px; font-size: 1rem; }
    button:hover { background-color: #ff9900; }
    nav { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
    .hidden { display: none; }
  </style>
</head>

<body>

  <header>ğŸ“‹ Ù…Ù‡Ø§Ù…ÙŠ</header>

  <main>
    <nav>
      <button id="showTasks">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      <button id="showDone">ğŸ“˜ Ø§Ù„Ø³Ø¬Ù„</button>
      <button id="refresh">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </nav>

    <section id="tasks-section">
      <h2 class="section-title">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <ul id="taskList"></ul>
    </section>

    <section id="done-section" class="hidden">
      <h2 class="section-title">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h2>
      <ul id="doneList"></ul>
    </section>
  </main>

  <script>
    const API_URL = "https://zkr-495g.onrender.com/tasks";
    const CODE = "ran/ran*78";

    // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
    async function checkCode() {
      const saved = sessionStorage.getItem("authCode");
      if (saved !== CODE) {
        const entered = prompt("ğŸŸ  Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:");
        if (entered === CODE) sessionStorage.setItem("authCode", CODE);
        else { alert("âŒ ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!"); location.reload(); }
      }
    }

    // ğŸ§¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
    async function loadTasks(showNotify = false) {
      try {
        const res = await fetch(API_URL + "?_=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…");

        const tasks = await res.json();
        displayTasks(tasks);
        checkNewNotifications(tasks, showNotify);

      } catch (err) {
        console.error("Ø®Ø·Ø£:", err);
      }
    }

    // ğŸ–¼ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    function displayTasks(tasks) {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      const done = JSON.parse(localStorage.getItem("doneTasks") || "[]");

      tasks.forEach(task => {
        const key = generateKey(task);

        if (!done.includes(key)) {
          const li = document.createElement("li");

          li.innerHTML = `
            <div>
              <strong>${task.subject || "Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø©"}</strong><br>
              ${task.text || ""}
            </div>
            <input type="checkbox">
          `;

          li.querySelector("input").addEventListener("change", () =>
            markDone(task)
          );

          taskList.appendChild(li);
        }
      });

      displayDoneTasks();
    }

    // ğŸŒŸ Ù…ÙˆÙ„Ø¯ Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù‡Ù…Ø© (Ø¨Ø¯ÙŠÙ„ Ø¹Ù† ID)
    function generateKey(task) {
      return (task.subject || "") + "___" + (task.text || "");
    }

    // âœ… ØªØ¹Ù„ÙŠÙ… Ù…Ù‡Ù…Ù‡ ÙƒÙ…Ù†Ø¬Ø²Ø©
    function markDone(task) {
      const done = JSON.parse(localStorage.getItem("doneTasks") || "[]");
      const key = generateKey(task);

      if (!done.includes(key)) {
        done.push(key);
        localStorage.setItem("doneTasks", JSON.stringify(done));
        loadTasks();
      }
    }

    // ğŸ“˜ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
    function displayDoneTasks() {
      const doneList = document.getElementById("doneList");
      const done = JSON.parse(localStorage.getItem("doneTasks") || "[]");

      doneList.innerHTML = "";

      fetch(API_URL + "?_=" + Date.now())
        .then(r => r.json())
        .then(tasks => {
          tasks.forEach(t => {
            const key = generateKey(t);
            if (done.includes(key)) {
              const li = document.createElement("li");
              li.classList.add("done");
              li.textContent = `${t.subject || "Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø©"} - ${t.text}`;
              doneList.appendChild(li);
            }
          });
        });
    }

    // ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function checkNewNotifications(tasks, showNotify) {
      if (!showNotify || Notification.permission !== "granted") return;

      if (tasks.length > (window.lastCount || 0)) {
        const t = tasks[tasks.length - 1];
        new Notification("ğŸ“š Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", {
          body: `${t.subject}: ${t.text}`,
          icon: "https://cdn-icons-png.flaticon.com/512/4712/4712107.png"
        });
      }

      window.lastCount = tasks.length;
    }

    // ğŸ§­ Ø§Ù„ØªÙ†Ù‚Ù„
    showTasks.onclick = () => {
      tasks-section.classList.remove("hidden");
      done-section.classList.add("hidden");
    };
    showDone.onclick = () => {
      done-section.classList.remove("hidden");
      tasks-section.classList.add("hidden");
    };
    refresh.onclick = () => loadTasks(true);

    // ğŸš€ ØªØ´ØºÙŠÙ„
    checkCode();
    Notification.requestPermission();
    loadTasks();
    setInterval(() => loadTasks(true), 15000);
  </script>

</body>
</html>
