<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø°ÙƒØ±Ù†ÙŠ - Ø§Ù„Ù…Ù‡Ø§Ù…</title>

  <style>
    * {
      box-sizing: border-box;
      font-family: "Tajawal", sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: #fff7f0;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      background-color: #ff8800;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    main {
      width: 100%;
      max-width: 500px;
      margin-top: 20px;
      padding: 10px;
    }

    .section-title {
      font-weight: bold;
      margin: 10px 0;
      color: #ff8800;
      font-size: 1.2rem;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.25s;
      cursor: pointer;
    }

    li:hover {
      transform: scale(1.03);
      background: #fff2e0;
    }

    @media (max-width: 600px) {
      header {
        font-size: 1.2rem;
      }
      li {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <header>ðŸ“‹ Ù…Ù‡Ø§Ù…ÙŠ</header>

  <main>
    <section>
      <h2 class="section-title">Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
      <ul id="taskList"></ul>
    </section>
  </main>

  <script>
    const API_URL = "https://zkr-495g.onrender.com/tasks";
    const CODE = "ran/ran*78";

    // ðŸ” ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
    async function checkCode() {
      let entered = sessionStorage.getItem("authCode");
      if (entered !== CODE) {
        entered = prompt("ðŸŸ  Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„:");
        if (entered === CODE) {
          sessionStorage.setItem("authCode", CODE);
        } else {
          alert("âŒ ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!");
          location.reload();
        }
      }
    }

    // ðŸ”¥ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
    localStorage.removeItem("doneTasks");

    // ðŸ§¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
    async function loadTasks(showNotify = false) {
      try {
        const res = await fetch(API_URL + "?t=" + Date.now()); // Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´
        const tasks = await res.json();
        displayTasks(tasks);
        checkForNewTasks(tasks, showNotify);
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…:", err);
      }
    }

    // ðŸ–¼ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù…
    function displayTasks(tasks) {
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";

      let doneTasks = JSON.parse(localStorage.getItem("doneTasks") || "[]");

      tasks.forEach(task => {
        const cleanedText = task.text.trim().toLowerCase();
        const key = task.id + "-" + cleanedText;

        if (doneTasks.includes(key)) return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ù†Ø¬Ø²Ø©

        const li = document.createElement("li");
        li.innerHTML = `
          <div>
            <strong>${task.subject || "Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø©"}</strong><br>
            ${task.text || ""}
          </div>
        `;

        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø© â†’ ØªØ­Ø°Ù
        li.onclick = () => deleteTask(task.id, task.text);

        taskList.appendChild(li);
      });
    }

    // ðŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©
    function deleteTask(id, text) {
      let doneTasks = JSON.parse(localStorage.getItem("doneTasks") || "[]");

      const cleanedText = text.trim().toLowerCase();
      const key = id + "-" + cleanedText;

      if (!doneTasks.includes(key)) {
        doneTasks.push(key);
        localStorage.setItem("doneTasks", JSON.stringify(doneTasks));
      }

      loadTasks();
    }

    // ðŸ”” Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    function askNotificationPermission() {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    // ðŸš¨ ÙƒØ´Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
    let lastTaskCount = 0;
    function checkForNewTasks(tasks, showNotify) {
      if (showNotify && Notification.permission === "granted") {
        if (tasks.length > lastTaskCount) {
          const newTask = tasks[tasks.length - 1];
          new Notification("ðŸ“š Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", {
            body: `ðŸ“˜ Ù…Ø§Ø¯Ø©: ${newTask.subject}\nâœï¸ ${newTask.text}`,
            icon: "https://cdn-icons-png.flaticon.com/512/4712/4712107.png"
          });
        }
      }
      lastTaskCount = tasks.length;
    }

    // ðŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    checkCode();
    askNotificationPermission();
    loadTasks();
    setInterval(() => loadTasks(true), 10000);
  </script>

</body>
</html>
